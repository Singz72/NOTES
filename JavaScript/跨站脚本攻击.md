# 跨站脚本攻击

## 描述

跨站脚本攻击（Cross-Site Scripting，XSS）是一种恶意代码注入。当 Web 应用存在安全漏洞，攻击者可以利用这个漏洞对网站注入客户端恶意代码，使被攻击用户在访问该网站时被执行恶意代码，导致用户信息、权限等受到危害。

客户端恶意代码一般是 JavaScript，但也可以是 HTML 等可以执行的代码。攻击者输入恶意代码，输出代码未经转译或者验证，浏览器也不知道代码是否可信任，依旧执行代码，导致发生了 XSS 攻击。

XSS 可能会造成的影响：

- 利用虚假输入表单骗取用户个人信息
- 利用脚本窃取用户的 Cookie
- 在被害者不知情的情况下帮助攻击者发送恶意请求
- 显示伪造的文章或者图片
- 将受害者重定向到攻击者指定的网站

PS：为了区别层叠样式表（Cascading Style Sheets，CSS）才简称 XSS。

## XSS 的分类

XSS 攻击根据攻击来源可以分为三类：存储型 XSS、反射型 XSS 和基于 DOM 的 XSS

### 存储型 XSS(Stored XSS)

当用户的输入会存储在目标服务器（例如消息、日志和评论等）上时，攻击者利用漏洞，存储具有恶意代码的内容到服务器，当用户访问这些内容时，并不知道内容是否可信，导致发生存储型 XSS。

一般攻击流程是：

1. 攻击者输入恶意代码到目标服务器（比如帖子）
2. 用户访问该帖子页面
3. 服务器直接返回具有恶意代码的内容给浏览器
4. 浏览器无差别解析渲染页面
5. 恶意代码执行，冒充用户行为或者窃取用户信息

### 反射型 XSS(Reflected XSS)

当用户的输入会立即得到服务器反馈（例如商城搜索结果、错误提示和其他响应等内容是部分或者全部来自于用户的请求）时，攻击者可以利用漏洞，对请求注入恶意代码，生成 URL 诱导用户访问，导致发生反射型 XSS。

一般攻击流程是：

1. 攻击者往输入框中输入恶意代码（比如在搜索页作为搜索关键词）
2. 生成恶意 URL
3. 诱导用户点击
4. 携带在 URL 中的恶意搜索关键词对服务器发起请求
5. 服务器将搜索关键词拼接在 HTML 中作为响应返回
6. 浏览器无差别解析渲染页面
7. 恶意代码执行，冒充用户行为或者窃取用户信息

### 基于 DOM 的 XSS(DOM Based XSS)

由于客户端某处存在潜在危险的 JavaScript 或者 DOM 对象，会接收并处理一个数据来源（比如 URL 里的查询字段），然而这个数据源是攻击者恶意制造的，便会导致发生基于 DOM 的 XSS 攻击。

一般的攻击流程：

1. 攻击者生成带有恶意查询的 URL
2. 诱导用户访问 URL
3. 浏览器无差别解析渲染页面
4. 客户端通过 document.location 读取查询字段
5. 查询字段直接传入 JavaScript 执行，，冒充用户行为或者窃取用户信息

比如攻击者知道网站`www.website.com`下存在漏洞代码，因为 JavaScript 语法是无法在 innerHTML 中执行的，但是存在标签`<img />`或者`<video />`是可以通过`onload`或者`onerror`来执行代码，攻击者通过在 URL 注入特殊的内容，然后被 JavaScript 截取下来作为内容使用，便有可能存在下面的情况，导致页面被恶意跳转:

```js
someDOMElement.innerHTML =
  "<img src=1 onerror=window.location='http://www.恶意网站.com' />";
```

攻击者除了在 URL 中注入恶意代码冒充用户行为外，还可以控制存储数据到浏览器中，然后可能导致以后在读取某些数据时会产生一些恶劣的行为。

这些用于开发并且容易被利用的数据来源常见的包括：

- document.URI
- document.documentURI
- document.URLUnencoded
- document.baseURI
- document.location
- document.cookie
- document.referrer
- history.pushState
- history.replaceState
- localStorage
- sessionStorage

开发中容易出现导致 DOM 型 XSS 的代码常包括：

- document.write()
- document.writeln()
- document.domain
- someDOMElement.innerHTML
- someDOMElement.outerHTML
- someDOMElement.insertAdjacentHTML
- someDOMElement.onevent

### 各类别间的异同

存储型 XSS 和反射型 XSS 都是需要服务端返回拼接好的 html，然后经过浏览器渲染执行恶意代码，而 DOM 型 XSS 则是由于客户端本身 JavaScript 代码问题导致的，恶意代码在执行时，页面根本无需响应，DOM 的执行环境很自然地发生了变化。

| 类型       | 存储区                  | 插入点          |
| ---------- | ----------------------- | --------------- |
| 存储型 XSS | 后端数据库              | HTML            |
| 反射型 XSS | URL                     | HTML            |
| DOM 型 XSS | 后端数据库/前端存储/URL | 前端 JavaScript |

## 防范 XSS 攻击
