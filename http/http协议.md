# http 协议

## 什么是 http 协议

http 协议用于建立客户端和服务器之间的通信，以一种请求&响应的交换完成这种通信。

建立通信的过程中，由客户端率先发起请求，服务器接收到请求后便会做出响应。

请求中，客户端会发出请求报文，报文需要明确指出请求的方法、请求需要访问的资源对象（URI），以及协议版本：

```http
GET /user/index.html HTTP/1.1
Host: xxx.com
Connection: keep-alive

xxx=实体内容
```

- GET：请求方法
- /user/index.html：需要访问的资源
- HTTP/1.1：协议版本
- Host：可选，请求的首部字段
- Connection：可选，请求的首部字段
- xxx=实体内容：可选，请求的实体内容

服务器收到请求后，将处理结果作为响应返回：

```http
HTTP/1.1 200 ok
Date: Mon Jun 29 2020 00:18:52 GMT+0800
Content-Length: 1000
Content-Type: text/html

<html>
...
</html>
```

- HTTP/1.1：协议版本
- 200 ok：响应状态码
- Date：响应返回时间，响应的首部字段
- Content-Length：响应内容长度，响应的首部字段
- Content-Type：响应类型，响应首部字段
- html：响应内容

## HTTP 请求方法

通信过程中可以指定请求方法来达到不同的目的：

- GET：获取资源，请求访问被 URI 识别的资源
- POST：传输实体主体，传输指定信息给服务器
- PUT：传输文件，通过在报文中包含文件内容，然后存储到请求 URI 指定的位置，但因为不带验证机制，导致安全性问题，不建议使用
- DELETE：删除文件，删除 URI 指向的资源文件，同 PUT 不带验证机制，所以不常使用
- HEAD：获取报文首部，同 GET 获取被 URI 识别的资源，但是不会返回报文主体内容，只返回报文头部，一般用来验证 URI 的有效性和资源更新时间
- OPTIONS：询问服务器支持的请求方法
- TRACE：追踪路径，因为可能存在代理中专，所以用来跟踪请求发送出去后是怎么被加工修改的
- CONNECT：要求用隧道协议连接代理

## http 持久链接

因为在客户端和服务器通信的过程中，在 HTTP1.0 版本中，每完成一次通信，TCP 就会断开一次，即每完成一个请求，TCP 就会断开，然后下次请求时，又要重新进行 TCP 连接，这样就会导致请求耗时耗资源。

不过在后续的 HTTP1.1 版本中加入了一个头部字段：Connection:keep-alive，用以使通信保持持续连接，除非其中一方提出断开连接，那么就一直保持 TCP 连接状态，这样在需要发送多个请求的过程中，就不会一直发生 TCP 断开和连接的过程，为请求和响应节省了时间，也减轻了服务器的负载，使 web 页面能更快的显示。

也因为持久连接的存在，使多数请求能够管线化方法发送成为可能，即可以同时发送许多个请求，而不必等待前一个请求返回响应后再执行下一个请求，可以类比异步请求。

## http 无状态和状态管理

http 是无状态协议。

因为 http 协议设计的足够简单，所以会存在在通信过程中，http 不会记录每次请求的状态，即后面的请求无法根据前面的状态进行对应处理。放到实际中就会发生 web 页面登陆后，当用户在新的标签页访问 web 页面时，服务器是无法知道这个用户其实是已经登陆的，或者在每次访问接口后都需要手动传递状态属性来保持用户状态。

因此加入了 cookie 技术，cookie 会携带在请求和响应的报文中，专门用以保存和控制状态。

简单的描述就是：

1. 客户端初次访问服务器
2. 服务器生成响应数据+cookie，并返回
3. 客户端接收到响应，浏览器会自动将返回的 cookie 存入该域名下
4. 客户端再次访问服务器，浏览器会自动在请求的报文头部中加入该域名的 cookie
5. 服务器获取到请求中的 cookie，验证 cookie 是哪个用户，再返回对应用户的响应数据+cookie
6. 浏览器接收到响应

因为 cookie 做状态管理会存在许多弊端：

1. cookie 是绑定域名的，所以不能跨域
2. 用户信息是明文存在于浏览器里的，不安全
3. 大小限制，每个 cookie 最大 4k
4. 数量限制，同一个域名下最多存储 20 个 cookie
5. 移动端支持不友好

总的来说也就是不灵活，所以也催生出其他的一些状态管理的技术：

- session：依赖于 cookie，但比 cookie 安全，主要信息都存储在服务器
- token：一种加密凭证，由服务器提供，可以存储在 localStorage 里，可跨域，移动端支持良好
- JWT：JSON Web Token，类似于 token
